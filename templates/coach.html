<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard — EdgeCare</title>
    <meta name="description" content="EdgeCare Coach Dashboard — weekly player analytics. Read-only.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* =====================================================================
           EdgeCare Coach Dashboard — Design System
           Analytics dashboard layout. No logging UI. Read-only.
           ===================================================================== */
        :root {
            --bg: #f1f5fb;
            --sidebar: #0f172a;
            --sidebar-text: rgba(255, 255, 255, 0.55);
            --sidebar-act: rgba(255, 255, 255, 0.12);
            --topbar: #ffffff;
            --card: #ffffff;
            --card-hover: #f8faff;
            --border: #e2e8f0;
            --accent: #3b82f6;
            --accent-dark: #1d4ed8;
            --accent-mid: #2563eb;
            --accent-light: #dbeafe;
            --accent-alpha: rgba(59, 130, 246, 0.10);
            --text-head: #0f172a;
            --text-body: #374151;
            --text-muted: #94a3b8;
            --text-sub: #64748b;
            --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 18px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 36px rgba(0, 0, 0, 0.11);
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-body);
            -webkit-font-smoothing: antialiased;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ── Top Navigation Bar ─────────────────────────────────── */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--sidebar);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            padding: 0 28px;
            height: 60px;
            gap: 20px;
        }

        .topbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .brand-icon {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-name {
            font-size: 17px;
            font-weight: 800;
            color: #ffffff;
            letter-spacing: -0.4px;
        }

        .brand-divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.15);
            margin: 0 4px;
        }

        .brand-role {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .topbar-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .topbar-title {
            font-size: 15px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.2px;
        }

        .topbar-subtitle {
            font-size: 11px;
            color: var(--sidebar-text);
            margin-left: 8px;
            font-weight: 500;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-shrink: 0;
        }

        .readonly-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(59, 130, 246, 0.18);
            color: #93c5fd;
            padding: 4px 11px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.4px;
        }

        .logout-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.10);
            padding: 6px 13px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.16);
            color: #ffffff;
        }

        /* ── Main Layout ─────────────────────────────────────────── */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 28px 24px 48px;
            gap: 24px;
        }

        /* ── Page Header ─────────────────────────────────────────── */
        .page-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .page-header-left h1 {
            font-size: 26px;
            font-weight: 800;
            color: var(--text-head);
            letter-spacing: -0.6px;
        }

        .page-header-left p {
            font-size: 14px;
            color: var(--text-sub);
            margin-top: 3px;
            font-weight: 400;
        }

        /* ── Player Selector ─────────────────────────────────────── */
        .selector-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 18px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
        }

        .selector-label-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .selector-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-head);
            letter-spacing: -0.1px;
        }

        .selector-hint {
            font-size: 11px;
            color: var(--text-muted);
        }

        .player-select {
            padding: 9px 38px 9px 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-head);
            background: var(--bg);
            outline: none;
            cursor: pointer;
            transition: var(--transition);
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            min-width: 180px;
        }

        .player-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
        }

        .selector-meta {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }

        /* ── Stats Grid ──────────────────────────────────────────── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px 18px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            animation: fadeUp 0.35s ease both;
        }

        .stat-card:nth-child(2) {
            animation-delay: 0.04s;
        }

        .stat-card:nth-child(3) {
            animation-delay: 0.08s;
        }

        .stat-card:nth-child(4) {
            animation-delay: 0.12s;
        }

        .stat-card:nth-child(5) {
            animation-delay: 0.16s;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            background: var(--accent-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-head);
            letter-spacing: -0.8px;
            line-height: 1;
        }

        .stat-value.text-val {
            font-size: 15px;
            font-weight: 700;
            letter-spacing: -0.3px;
            line-height: 1.3;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        /* ── Charts Row ──────────────────────────────────────────── */
        .charts-row {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 16px;
        }

        @media (max-width: 800px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 22px;
            box-shadow: var(--shadow-sm);
            animation: fadeUp 0.4s ease both;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-head);
        }

        .chart-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chart-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--accent-alpha);
            color: var(--accent-dark);
            padding: 3px 9px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 600;
        }

        .chart-canvas-wrap {
            position: relative;
        }

        .chart-canvas-wrap.h220 {
            height: 220px;
        }

        .chart-canvas-wrap.h250 {
            height: 250px;
        }

        /* ── Bottom Row ──────────────────────────────────────────── */
        .bottom-row {
            display: grid;
            grid-template-columns: 1fr 1.8fr;
            gap: 16px;
        }

        @media (max-width: 800px) {
            .bottom-row {
                grid-template-columns: 1fr;
            }
        }

        /* ── Observation Box ─────────────────────────────────────── */
        .observation-card {
            background: var(--accent-alpha);
            border: 1px solid rgba(59, 130, 246, 0.18);
            border-radius: var(--radius-md);
            padding: 22px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            box-shadow: var(--shadow-sm);
        }

        .obs-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .obs-icon {
            width: 36px;
            height: 36px;
            background: rgba(59, 130, 246, 0.14);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .obs-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .obs-text {
            font-size: 14px;
            color: #1e3a8a;
            line-height: 1.7;
            font-weight: 450;
        }

        .obs-disclaimer {
            font-size: 11px;
            color: var(--accent);
            font-style: italic;
            margin-top: 4px;
            opacity: 0.8;
        }

        /* ── Recent Logs Table ───────────────────────────────────── */
        .table-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table-card-header {
            padding: 18px 22px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-head);
        }

        .table-readonly-tag {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 3px 9px;
            border-radius: 99px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table thead tr {
            background: #f8fafc;
        }

        .data-table th {
            padding: 10px 18px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            border-bottom: 1px solid var(--border);
        }

        .data-table th.center {
            text-align: center;
        }

        .data-table td {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: var(--bg);
        }

        .td-date {
            font-weight: 700;
            color: var(--text-head);
        }

        .td-area {
            color: var(--text-sub);
        }

        .td-sev {
            text-align: center;
        }

        .sev-chip {
            display: inline-block;
            padding: 3px 10px;
            background: var(--accent-light);
            color: var(--accent-dark);
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
        }

        /* ── Loading / Empty States ─────────────────────────────── */
        .state-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            padding: 60px 24px;
            text-align: center;
        }

        .state-icon {
            width: 56px;
            height: 56px;
            background: var(--accent-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .state-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-head);
        }

        .state-body {
            font-size: 13px;
            color: var(--text-muted);
            max-width: 300px;
            line-height: 1.65;
        }

        /* spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2.5px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-inline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 40px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* ── Section Label ──────────────────────────────────────── */
        .section-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* ── Footer ─────────────────────────────────────────────── */
        .page-footer {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            padding: 8px 0 0;
            line-height: 1.7;
        }
    </style>
</head>

<body>

    <!-- ══════════════════════════════════════════════════════════════
         TOP NAVIGATION BAR
    ═══════════════════════════════════════════════════════════════ -->
    <nav class="topbar">
        <div class="topbar-brand">
            <div class="brand-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2.3">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
            </div>
            <span class="brand-name">EdgeCare</span>
            <div class="brand-divider"></div>
            <span class="brand-role">Coach</span>
        </div>

        <div class="topbar-center">
            <span class="topbar-title">Coach Dashboard</span>
            <span class="topbar-subtitle">· Weekly Player Summary</span>
        </div>

        <div class="topbar-right">
            <span class="readonly-badge">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Read Only
            </span>
            <a href="/logout" class="logout-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                Logout
            </a>
        </div>
    </nav>

    <!-- ══════════════════════════════════════════════════════════════
         MAIN CONTENT
    ═══════════════════════════════════════════════════════════════ -->
    <div class="main-wrapper">

        <!-- Page Title -->
        <div class="page-header">
            <div class="page-header-left">
                <h1>Weekly Player Summary</h1>
                <p>Last 7 days · Observation only · No modifications permitted</p>
            </div>
        </div>

        <!-- ── Player Selector ──────────────────────────────────── -->
        <div class="selector-panel">
            <div class="selector-label-group">
                <span class="selector-label">Select Player</span>
                <span class="selector-hint">Changing selection refreshes all stats</span>
            </div>
            <select class="player-select" id="playerSelect">
                <option value="">Loading players…</option>
            </select>
            <span class="selector-meta" id="selectorMeta">Populated from live data</span>
        </div>

        <!-- ── Dynamic Dashboard Content ──────────────────────── -->
        <div id="dashboardContent">
            <div class="loading-inline">
                <div class="spinner"></div>
                Loading player data…
            </div>
        </div>

        <!-- ── Load Guidance Section (Rule-Based, Advisory) ────── -->
        <div id="loadGuidanceSection" style="display: none; margin-top: 24px;">
            <div class="section-label" style="margin-bottom: 12px;">Load Guidance</div>
            <div class="stat-card" style="border-left: 4px solid var(--accent); background: #f8fafc;">
                <div style="font-size: 15px; font-weight: 500; color: var(--text-head); line-height: 1.6;">
                    <span id="loadGuidanceText">Initializing guidance...</span>
                </div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px; font-style: italic;">
                    * Advisory only. Based on weekly observation statistics.
                </div>
            </div>
        </div>

    </div><!-- /main-wrapper -->


    <script>
        // ================================================================
        //  EdgeCare Coach Dashboard — Frontend Logic
        //  Route: /coach (Coach role only)
        //  API:   /api/coach_weekly/<player_id>   (GET, read-only)
        //  Rules: No logging. No POST. No data modification. Blue palette.
        // ================================================================

        const BLUE = '#3b82f6';
        const BLUE_FILL = 'rgba(59,130,246,0.12)';
        const BAR_BLUES = [
            '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af',
            '#0ea5e9', '#0284c7', '#0369a1', '#075985',
            '#38bdf8', '#7dd3fc', '#4338ca', '#6366f1'
        ];

        /* ── Utility: destroy all Chart.js instances ──────────────── */
        function destroyAllCharts() {
            const ids = Object.keys(Chart.instances);
            ids.forEach(id => Chart.instances[id]?.destroy());
        }

        /* ── 1. Initialise player selector ──────────────────────── */
        async function initSelector() {
            const sel = document.getElementById('playerSelect');
            try {
                const res = await fetch('/api/players');
                const players = await res.json();

                if (!Array.isArray(players) || players.length === 0) {
                    sel.innerHTML = '<option value="">No players found</option>';
                    document.getElementById('selectorMeta').textContent = 'No player data in CSV';
                    return;
                }

                sel.innerHTML = players.map(id =>
                    `<option value="${id}">${id}</option>`
                ).join('');

                document.getElementById('selectorMeta').textContent =
                    `${players.length} player${players.length !== 1 ? 's' : ''} found`;

                loadData();          // auto-load first player
            } catch (err) {
                sel.innerHTML = '<option value="">Error loading players</option>';
                console.error('Player fetch failed:', err);
            }
        }

        document.getElementById('playerSelect').addEventListener('change', loadData);

        /* ── 2. Load analytics for selected player ──────────────── */
        async function loadData() {
            const playerId = document.getElementById('playerSelect').value;
            const container = document.getElementById('dashboardContent');

            if (!playerId) return;

            container.innerHTML = `
            <div class="loading-inline">
                <div class="spinner"></div>
                Loading data for ${playerId}…
            </div>`;

            try {
                const res = await fetch(`/api/coach_weekly/${encodeURIComponent(playerId)}`);
                const data = await res.json();

                destroyAllCharts();

                if (!data.has_data) {
                    renderEmpty(container, playerId);
                } else {
                    renderDashboard(container, data);
                }
            } catch (err) {
                container.innerHTML = `
                <div class="state-box">
                    <p class="state-body" style="color:#64748b">
                        Could not retrieve data. Please check the server is running.
                    </p>
                </div>`;
                console.error('Data fetch failed:', err);
            }
        }

        /* ── 3. Empty state ─────────────────────────────────────── */
        function renderEmpty(container, playerId) {
            container.innerHTML = `
            <div style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:0">
                <div class="state-box">
                    <div class="state-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                             stroke="#3b82f6" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <p class="state-title">No entries recorded this week</p>
                    <p class="state-body">
                        No logs were found for <strong>${playerId}</strong>
                        in the last 7 days. Entries will appear here once recorded.
                    </p>
                </div>
            </div>`;
        }

        /* ── 4. Full dashboard render ───────────────────────────── */
        function renderDashboard(container, data) {
            const {
                total_logs, average_severity, pain_days,
                most_logged_area, most_active_day,
                frequency_by_area, daily_average,
                summary_text, load_guidance  // <--- Added load_guidance
            } = data;

            // Update Load Guidance Section
            const guidanceSection = document.getElementById('loadGuidanceSection');
            const guidanceText = document.getElementById('loadGuidanceText');

            if (guidanceSection && guidanceText) {
                if (load_guidance) {
                    guidanceText.textContent = load_guidance;
                    guidanceSection.style.display = 'block';
                } else {
                    guidanceSection.style.display = 'none';
                }
            }

            // Shorten long area names for the stat card
            const areaShort = most_logged_area.length > 16
                ? most_logged_area.replace(/^(Left|Right) /, m => m.trim()[0] + '. ')
                : most_logged_area;

            container.innerHTML = `

            <!-- ── Stat Cards ─────────────────────────────── -->
            <div class="stats-grid">

                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="${BLUE}" stroke-width="2.2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <span class="stat-value">${total_logs}</span>
                    <span class="stat-label">Total Logs · 7 days</span>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="${BLUE}" stroke-width="2.2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </div>
                    <span class="stat-value">${average_severity}</span>
                    <span class="stat-label">Average Severity</span>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="${BLUE}" stroke-width="2.2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8"  y1="2" x2="8"  y2="6"/>
                            <line x1="3"  y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                    <span class="stat-value">${pain_days}</span>
                    <span class="stat-label">Days with Entries</span>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="${BLUE}" stroke-width="2.2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <span class="stat-value text-val">${areaShort}</span>
                    <span class="stat-label">Most Logged Area</span>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="${BLUE}" stroke-width="2.2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <span class="stat-value text-val">${most_active_day || '—'}</span>
                    <span class="stat-label">Most Active Day</span>
                </div>

            </div>

            <!-- ── Charts Row ─────────────────────────────── -->
            <div class="charts-row">

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <p class="chart-title">Daily Severity Trend</p>
                            <p class="chart-subtitle">Average severity per day · last 7 days</p>
                        </div>
                        <span class="chart-badge">Y-axis: 1 – 10</span>
                    </div>
                    <div class="chart-canvas-wrap h220">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <p class="chart-title">Frequency by Body Area</p>
                            <p class="chart-subtitle">Entry count per area</p>
                        </div>
                    </div>
                    <div class="chart-canvas-wrap h220">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

            </div>

            <!-- ── Observational Summary (full width) ──────── -->
            <div class="observation-card">
                <div class="obs-header">
                    <div class="obs-icon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                             stroke="#3b82f6" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8"  x2="12.01" y2="8"/>
                        </svg>
                    </div>
                    <span class="obs-title">Observational Summary</span>
                </div>
                <p class="obs-text">${summary_text}</p>
                <p class="obs-disclaimer">
                    Pattern reflection only. Not a clinical assessment.
                </p>
            </div>

            <div class="page-footer">
                This dashboard presents observed data only.
                Intended for awareness purposes — not for clinical diagnosis or medical assessment.
            </div>`;

            // Draw charts after DOM update
            requestAnimationFrame(() => {
                buildLineChart(daily_average);
                buildBarChart(frequency_by_area);
            });
        }

        /* ── Chart 1: Line — daily average severity ─────────────── */
        function buildLineChart(dailyAvg) {
            const labels = Object.keys(dailyAvg);
            const values = Object.values(dailyAvg);   // null = no entries that day

            const ctx = document.getElementById('lineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Avg Severity',
                        data: values,
                        spanGaps: true,
                        borderColor: BLUE,
                        backgroundColor: BLUE_FILL,
                        pointBackgroundColor: BLUE,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.parsed.y === null
                                    ? ' No entries'
                                    : ` Avg severity: ${ctx.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(0,0,0,0.04)' },
                            ticks: {
                                font: { size: 12, family: 'Inter' },
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            min: 0,
                            max: 10,
                            grid: { color: 'rgba(0,0,0,0.04)' },
                            ticks: {
                                stepSize: 2,
                                font: { size: 12, family: 'Inter' },
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        /* ── Chart 2: Horizontal Bar — entries per body area ────── */
        function buildBarChart(freqByArea) {
            const entries = Object.entries(freqByArea).sort((a, b) => b[1] - a[1]);
            const labels = entries.map(e => e[0]);
            const values = entries.map(e => e[1]);
            const colors = entries.map((_, i) => BAR_BLUES[i % BAR_BLUES.length]);

            const ctx = document.getElementById('barChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Entries',
                        data: values,
                        backgroundColor: colors.map(c => c + 'bb'),
                        borderColor: colors,
                        borderWidth: 1.5,
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx =>
                                    ` ${ctx.parsed.x} entr${ctx.parsed.x === 1 ? 'y' : 'ies'}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(0,0,0,0.04)' },
                            ticks: {
                                stepSize: 1,
                                font: { size: 11, family: 'Inter' },
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11, family: 'Inter' },
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        // ── Boot ─────────────────────────────────────────────────────
        initSelector();

    </script>

</body>

</html>